services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: frontend
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8080}
      - WATCHPACK_POLLING=true
      - CHOKIDAR_USEPOLLING=true
    volumes:
      # Mount source code for hot reload
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    depends_on:
      - backend
    restart: unless-stopped

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: backend
    env_file:
      - .env
    ports:
      - "8080:8080"
    volumes:
      - ./backend/src:/app/src
      - ./backend/go.mod:/app/go.mod
      - ./backend/go.sum:/app/go.sum
      - /app/tmp
      - /app/bin
    depends_on:
      - dynamodb
    restart: unless-stopped

  dynamodb:
    image: amazon/dynamodb-local
    container_name: dynamodb
    ports:
      - "8000:8000"
    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath /data"
    volumes:
      # Persist DynamoDB data
      - ./dynamodb-data:/data
    healthcheck:
      test: ["CMD", "timeout", "1", "bash", "-c", ":> /dev/tcp/localhost/8000"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s
    restart: unless-stopped

  dynamodb-init:
    image: amazon/aws-cli:latest
    container_name: dynamodb-init
    env_file:
      - .env
    depends_on:
      dynamodb:
        condition: service_healthy
    entrypoint: /bin/sh
    command: >
      -c "
      echo 'Waiting for DynamoDB to be ready...';
      sleep 2;
      aws dynamodb create-table --table-name Users --attribute-definitions AttributeName=ID,AttributeType=S --key-schema AttributeName=ID,KeyType=HASH --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 --endpoint-url http://dynamodb:8000 --region ap-southeast-2 || echo 'Table Users may already exist';
      echo 'DynamoDB tables initialized!';
      "
    networks:
      - default

